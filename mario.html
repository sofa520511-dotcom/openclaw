<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë∂ÖÁ¥öÁë™Âà©Ê≠ê üçÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #5c94fc 0%, #5c94fc 60%, #8b4513 100%);
            font-family: 'Press Start 2P', 'Courier New', monospace;
            overflow: hidden;
        }

        .game-header {
            color: white;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 3px 3px 0 #000;
        }

        .game-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
            font-size: 0.9rem;
        }

        .game-container {
            position: relative;
            border: 4px solid #000;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        canvas {
            display: block;
            background: linear-gradient(180deg, #5c94fc 0%, #5c94fc 70%, transparent 70%);
        }

        .controls {
            margin-top: 15px;
            color: white;
            text-align: center;
            font-size: 0.7rem;
            text-shadow: 2px 2px 0 #000;
        }

        .mobile-controls {
            display: none;
            margin-top: 20px;
            gap: 10px;
        }

        .mobile-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            text-shadow: 2px 2px 0 #000;
            touch-action: manipulation;
        }

        .mobile-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        .jump-btn {
            width: 80px;
            height: 80px;
            font-size: 0.8rem;
            margin-left: 30px;
        }

        @media (max-width: 600px) {
            .mobile-controls {
                display: flex;
                align-items: center;
            }
            .controls {
                display: none;
            }
            canvas {
                max-width: 100vw;
            }
        }

        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 30px 50px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            border: 4px solid #ffd700;
            z-index: 100;
        }

        .message button {
            margin-top: 20px;
            padding: 10px 30px;
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            background: #e52521;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .message button:hover {
            background: #ff3b30;
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>üçÑ Ë∂ÖÁ¥öÁë™Âà©Ê≠ê</h1>
        <div class="stats">
            <span>ÈáëÂπ£: <span id="coins">0</span> ü™ô</span>
            <span>ÂàÜÊï∏: <span id="score">0</span></span>
            <span>ÁîüÂëΩ: <span id="lives">3</span> ‚ù§Ô∏è</span>
        </div>
    </div>
    
    <div class="game-container">
        <canvas id="game" width="800" height="400"></canvas>
    </div>
    
    <p class="controls">‚Üê ‚Üí ÁßªÂãï ÔΩú Á©∫ÁôΩÈçµ Ë∑≥Ë∫ç ÔΩú Ë∏©Êïµ‰∫∫ÂæóÂàÜÔºÅ</p>
    
    <div class="mobile-controls">
        <button class="mobile-btn" id="leftBtn">‚óÄ</button>
        <button class="mobile-btn" id="rightBtn">‚ñ∂</button>
        <button class="mobile-btn jump-btn" id="jumpBtn">Ë∑≥</button>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');

        // Game state
        let gameRunning = true;
        let coins = 0;
        let score = 0;
        let lives = 3;
        let cameraX = 0;
        let levelComplete = false;

        // Mario
        const mario = {
            x: 50,
            y: 300,
            width: 32,
            height: 40,
            vx: 0,
            vy: 0,
            speed: 5,
            jumpForce: -14,
            grounded: false,
            facing: 1,
            frame: 0,
            frameTimer: 0
        };

        // Physics
        const gravity = 0.6;
        const friction = 0.8;

        // Level design
        const platforms = [
            // Ground
            { x: 0, y: 360, width: 500, height: 40, type: 'ground' },
            { x: 550, y: 360, width: 300, height: 40, type: 'ground' },
            { x: 900, y: 360, width: 600, height: 40, type: 'ground' },
            { x: 1600, y: 360, width: 800, height: 40, type: 'ground' },
            
            // Platforms
            { x: 200, y: 280, width: 100, height: 20, type: 'brick' },
            { x: 350, y: 200, width: 60, height: 20, type: 'question' },
            { x: 600, y: 260, width: 80, height: 20, type: 'brick' },
            { x: 750, y: 180, width: 100, height: 20, type: 'brick' },
            { x: 950, y: 280, width: 60, height: 20, type: 'question' },
            { x: 1100, y: 200, width: 120, height: 20, type: 'brick' },
            { x: 1300, y: 260, width: 60, height: 20, type: 'question' },
            { x: 1450, y: 180, width: 80, height: 20, type: 'brick' },
            { x: 1700, y: 250, width: 100, height: 20, type: 'brick' },
            { x: 1900, y: 180, width: 60, height: 20, type: 'question' },
        ];

        // Coins
        let coinList = [
            { x: 230, y: 240, collected: false },
            { x: 370, y: 160, collected: false },
            { x: 620, y: 220, collected: false },
            { x: 780, y: 140, collected: false },
            { x: 970, y: 240, collected: false },
            { x: 1140, y: 160, collected: false },
            { x: 1320, y: 220, collected: false },
            { x: 1480, y: 140, collected: false },
            { x: 1730, y: 210, collected: false },
            { x: 1920, y: 140, collected: false },
        ];

        // Enemies (Goombas)
        let enemies = [
            { x: 400, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
            { x: 700, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
            { x: 1000, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
            { x: 1250, y: 328, width: 32, height: 32, vx: 1.5, alive: true },
            { x: 1550, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
            { x: 1800, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
        ];

        // Flag
        const flag = { x: 2100, y: 160, width: 10, height: 200 };

        // Input
        const keys = {};

        document.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === 'Space') e.preventDefault();
        });
        document.addEventListener('keyup', e => keys[e.code] = false);

        // Mobile controls
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const jumpBtn = document.getElementById('jumpBtn');

        leftBtn.addEventListener('touchstart', e => { e.preventDefault(); keys['ArrowLeft'] = true; });
        leftBtn.addEventListener('touchend', e => { e.preventDefault(); keys['ArrowLeft'] = false; });
        rightBtn.addEventListener('touchstart', e => { e.preventDefault(); keys['ArrowRight'] = true; });
        rightBtn.addEventListener('touchend', e => { e.preventDefault(); keys['ArrowRight'] = false; });
        jumpBtn.addEventListener('touchstart', e => { e.preventDefault(); keys['Space'] = true; });
        jumpBtn.addEventListener('touchend', e => { e.preventDefault(); keys['Space'] = false; });

        function update() {
            if (!gameRunning || levelComplete) return;

            // Input
            if (keys['ArrowLeft'] || keys['KeyA']) {
                mario.vx = -mario.speed;
                mario.facing = -1;
            } else if (keys['ArrowRight'] || keys['KeyD']) {
                mario.vx = mario.speed;
                mario.facing = 1;
            } else {
                mario.vx *= friction;
            }

            if ((keys['Space'] || keys['ArrowUp'] || keys['KeyW']) && mario.grounded) {
                mario.vy = mario.jumpForce;
                mario.grounded = false;
            }

            // Physics
            mario.vy += gravity;
            mario.x += mario.vx;
            mario.y += mario.vy;

            // Animation
            if (Math.abs(mario.vx) > 0.5) {
                mario.frameTimer++;
                if (mario.frameTimer > 6) {
                    mario.frame = (mario.frame + 1) % 3;
                    mario.frameTimer = 0;
                }
            } else {
                mario.frame = 0;
            }

            // Platform collision
            mario.grounded = false;
            for (const plat of platforms) {
                if (mario.x + mario.width > plat.x && mario.x < plat.x + plat.width) {
                    if (mario.y + mario.height > plat.y && mario.y + mario.height < plat.y + plat.height + mario.vy + 5) {
                        if (mario.vy >= 0) {
                            mario.y = plat.y - mario.height;
                            mario.vy = 0;
                            mario.grounded = true;
                        }
                    }
                }
            }

            // Coin collection
            for (const coin of coinList) {
                if (!coin.collected) {
                    const dx = (mario.x + mario.width / 2) - coin.x;
                    const dy = (mario.y + mario.height / 2) - coin.y;
                    if (Math.sqrt(dx * dx + dy * dy) < 25) {
                        coin.collected = true;
                        coins++;
                        score += 100;
                        updateStats();
                    }
                }
            }

            // Enemy update & collision
            for (const enemy of enemies) {
                if (!enemy.alive) continue;

                enemy.x += enemy.vx;

                // Enemy platform check
                for (const plat of platforms) {
                    if (plat.type === 'ground') {
                        if (enemy.x < plat.x || enemy.x + enemy.width > plat.x + plat.width) {
                            if (enemy.y + enemy.height >= plat.y) {
                                enemy.vx *= -1;
                            }
                        }
                    }
                }

                // Mario vs Enemy
                if (mario.x + mario.width > enemy.x && mario.x < enemy.x + enemy.width &&
                    mario.y + mario.height > enemy.y && mario.y < enemy.y + enemy.height) {
                    
                    if (mario.vy > 0 && mario.y + mario.height < enemy.y + enemy.height / 2 + mario.vy) {
                        // Stomp enemy
                        enemy.alive = false;
                        mario.vy = -10;
                        score += 200;
                        updateStats();
                    } else {
                        // Hit by enemy
                        lives--;
                        updateStats();
                        if (lives <= 0) {
                            gameOver();
                        } else {
                            resetMario();
                        }
                    }
                }
            }

            // Fall death
            if (mario.y > 500) {
                lives--;
                updateStats();
                if (lives <= 0) {
                    gameOver();
                } else {
                    resetMario();
                }
            }

            // Camera
            cameraX = mario.x - canvas.width / 3;
            if (cameraX < 0) cameraX = 0;
            if (cameraX > 1500) cameraX = 1500;

            // Level complete
            if (mario.x > flag.x) {
                levelComplete = true;
                showMessage('üéâ ÊÅ≠ÂñúÈÅéÈóúÔºÅ', `ÂàÜÊï∏: ${score}`, true);
            }
        }

        function draw() {
            // Clear
            ctx.fillStyle = '#5c94fc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cameraX, 0);

            // Clouds
            drawClouds();

            // Platforms
            for (const plat of platforms) {
                if (plat.type === 'ground') {
                    // Ground pattern
                    ctx.fillStyle = '#8b4513';
                    ctx.fillRect(plat.x, plat.y, plat.width, plat.height);
                    ctx.fillStyle = '#228b22';
                    ctx.fillRect(plat.x, plat.y, plat.width, 10);
                } else if (plat.type === 'brick') {
                    drawBrick(plat.x, plat.y, plat.width, plat.height);
                } else if (plat.type === 'question') {
                    drawQuestionBlock(plat.x, plat.y, plat.width, plat.height);
                }
            }

            // Coins
            for (const coin of coinList) {
                if (!coin.collected) {
                    drawCoin(coin.x, coin.y);
                }
            }

            // Enemies
            for (const enemy of enemies) {
                if (enemy.alive) {
                    drawGoomba(enemy.x, enemy.y, enemy.width, enemy.height);
                }
            }

            // Flag
            drawFlag(flag.x, flag.y);

            // Mario
            drawMario();

            ctx.restore();
        }

        function drawClouds() {
            ctx.fillStyle = 'white';
            const clouds = [100, 400, 700, 1100, 1500, 1900];
            for (let i = 0; i < clouds.length; i++) {
                const x = clouds[i];
                const y = 50 + (i % 3) * 30;
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.arc(x + 30, y - 10, 30, 0, Math.PI * 2);
                ctx.arc(x + 60, y, 25, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawBrick(x, y, w, h) {
            ctx.fillStyle = '#c84c0c';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            // Brick pattern
            ctx.strokeStyle = '#8b3000';
            for (let i = 0; i < w; i += 20) {
                ctx.beginPath();
                ctx.moveTo(x + i, y);
                ctx.lineTo(x + i, y + h);
                ctx.stroke();
            }
        }

        function drawQuestionBlock(x, y, w, h) {
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = '#8b4513';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('?', x + w / 2, y + h / 2 + 6);
        }

        function drawCoin(x, y) {
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.ellipse(x, y, 10, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#daa520';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#daa520';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('$', x, y + 4);
        }

        function drawGoomba(x, y, w, h) {
            // Body
            ctx.fillStyle = '#8b4513';
            ctx.beginPath();
            ctx.ellipse(x + w / 2, y + h / 2 + 5, w / 2, h / 2 - 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Head
            ctx.fillStyle = '#a0522d';
            ctx.beginPath();
            ctx.ellipse(x + w / 2, y + 8, w / 2 + 2, 12, 0, Math.PI, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.ellipse(x + 10, y + 12, 5, 6, 0, 0, Math.PI * 2);
            ctx.ellipse(x + 22, y + 12, 5, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(x + 10, y + 13, 2, 0, Math.PI * 2);
            ctx.arc(x + 22, y + 13, 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Feet
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 2, y + h - 5, 10, 5);
            ctx.fillRect(x + w - 12, y + h - 5, 10, 5);
        }

        function drawFlag(x, y) {
            // Pole
            ctx.fillStyle = '#228b22';
            ctx.fillRect(x, y, 8, 200);
            
            // Flag
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.moveTo(x + 8, y);
            ctx.lineTo(x + 60, y + 25);
            ctx.lineTo(x + 8, y + 50);
            ctx.closePath();
            ctx.fill();
            
            // Ball on top
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(x + 4, y, 8, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawMario() {
            const x = mario.x;
            const y = mario.y;
            const dir = mario.facing;

            ctx.save();
            if (dir === -1) {
                ctx.translate(x + mario.width, 0);
                ctx.scale(-1, 1);
                ctx.translate(-x, 0);
            }

            // Hat
            ctx.fillStyle = '#e52521';
            ctx.fillRect(x + 6, y, 20, 8);
            ctx.fillRect(x + 2, y + 8, 28, 6);

            // Face
            ctx.fillStyle = '#fdbf6f';
            ctx.fillRect(x + 6, y + 14, 20, 12);

            // Eye
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 18, y + 16, 4, 4);

            // Mustache
            ctx.fillStyle = '#4a2800';
            ctx.fillRect(x + 10, y + 22, 14, 4);

            // Body
            ctx.fillStyle = '#e52521';
            ctx.fillRect(x + 4, y + 26, 24, 14);

            // Overalls
            ctx.fillStyle = '#0066cc';
            ctx.fillRect(x + 6, y + 32, 20, 8);

            // Legs
            const legOffset = mario.frame === 1 ? 2 : (mario.frame === 2 ? -2 : 0);
            ctx.fillStyle = '#0066cc';
            ctx.fillRect(x + 6, y + 32, 8, 8);
            ctx.fillRect(x + 18, y + 32, 8, 8);

            ctx.restore();
        }

        function updateStats() {
            document.getElementById('coins').textContent = coins;
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
        }

        function resetMario() {
            mario.x = 50;
            mario.y = 300;
            mario.vx = 0;
            mario.vy = 0;
            cameraX = 0;
        }

        function resetGame() {
            mario.x = 50;
            mario.y = 300;
            mario.vx = 0;
            mario.vy = 0;
            cameraX = 0;
            coins = 0;
            score = 0;
            lives = 3;
            levelComplete = false;
            gameRunning = true;

            // Reset coins
            for (const coin of coinList) {
                coin.collected = false;
            }

            // Reset enemies
            enemies = [
                { x: 400, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
                { x: 700, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
                { x: 1000, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
                { x: 1250, y: 328, width: 32, height: 32, vx: 1.5, alive: true },
                { x: 1550, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
                { x: 1800, y: 328, width: 32, height: 32, vx: -1.5, alive: true },
            ];

            updateStats();
            hideMessage();
        }

        function gameOver() {
            gameRunning = false;
            showMessage('üíÄ ÈÅäÊà≤ÁµêÊùü', `ÊúÄÁµÇÂàÜÊï∏: ${score}`, true);
        }

        function showMessage(title, subtitle, showButton) {
            let msg = document.querySelector('.message');
            if (!msg) {
                msg = document.createElement('div');
                msg.className = 'message';
                document.querySelector('.game-container').appendChild(msg);
            }
            msg.innerHTML = `
                <div>${title}</div>
                <div style="font-size: 0.8rem; margin-top: 10px;">${subtitle}</div>
                ${showButton ? '<button onclick="resetGame()">ÂÜçÁé©‰∏ÄÊ¨°</button>' : ''}
            `;
            msg.style.display = 'block';
        }

        function hideMessage() {
            const msg = document.querySelector('.message');
            if (msg) msg.style.display = 'none';
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
